<script>
  document.addEventListener('DOMContentLoaded', function () {
    const token = localStorage.getItem('accessToken');
    const authModal = document.getElementById('authModal');
    const app = document.getElementById('app');

    if (token) {
      // ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½ â€” ÑÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð¼Ð¾Ð´Ð°Ð»ÐºÑƒ, Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
      authModal.style.display = 'none';
      app.style.display = 'block';
      loadUserData(); // Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
      loadTasks();    // Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð·Ð°Ð´Ð°Ñ‡Ð¸
    } else {
      // ÐÐµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½ â€” Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ð¼Ð¾Ð´Ð°Ð»ÐºÑƒ
      authModal.style.display = 'block';
      app.style.display = 'none';
    }

    // === ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ Ñ„Ð¾Ñ€Ð¼ ===
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    document.getElementById('registerForm').addEventListener('submit', handleRegister);
    document.getElementById('logoutBtn').addEventListener('click', handleLogout);

    // === Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ ===
    async function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      const errorDiv = document.getElementById('loginError');

      try {
        const res = await fetch('/api/auth/login/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        if (res.ok) {
          const data = await res.json();
          localStorage.setItem('accessToken', data.tokens.access);
          location.reload(); // Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ â†’ Ð¿Ð¾ÐºÐ°Ð¶ÐµÑ‚ #app
        } else {
          const err = await res.json();
          errorDiv.textContent = err.detail || 'ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð»Ð¾Ð³Ð¸Ð½ Ð¸Ð»Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ';
        }
      } catch (err) {
        errorDiv.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ';
      }
    }

    async function handleRegister(e) {
      e.preventDefault();
      const username = document.getElementById('registerUsername').value;
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
      const errorDiv = document.getElementById('registerError');

      if (password !== passwordConfirm) {
        errorDiv.textContent = 'ÐŸÐ°Ñ€Ð¾Ð»Ð¸ Ð½Ðµ ÑÐ¾Ð²Ð¿Ð°Ð´Ð°ÑŽÑ‚';
        return;
      }

      try {
        const res = await fetch('/api/auth/register/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, email, password })
        });

        if (res.ok) {
          const data = await res.json();
          localStorage.setItem('accessToken', data.tokens.access);
          location.reload();
        } else {
          const err = await res.json();
          errorDiv.textContent = err.detail || 'ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸';
        }
      } catch (err) {
        errorDiv.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ';
      }
    }

    function handleLogout() {
      localStorage.removeItem('accessToken');
      location.reload(); // Ð²ÐµÑ€Ð½Ñ‘Ñ‚ Ðº Ð¼Ð¾Ð´Ð°Ð»ÐºÐµ Ð²Ñ…Ð¾Ð´Ð°
    }

    // === Ð’ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ (Ð¿Ñ€Ð¸Ð¼ÐµÑ€) ===
    async function loadUserData() {
      const token = localStorage.getItem('accessToken');
      try {
        const res = await fetch('/api/auth/me/', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.ok) {
          const user = await res.json();
          document.getElementById('currentUser').textContent = `ðŸ‘¤ ${user.username}`;
        }
      } catch (e) {
        console.error('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ');
      }
    }

    async function loadTasks() {
      const token = localStorage.getItem('accessToken');
      try {
        const res = await fetch('/api/tasks/', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.ok) {
          const tasks = await res.json();
          renderTasks(tasks);
        }
      } catch (e) {
        console.error('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð·Ð°Ð´Ð°Ñ‡Ð¸');
      }
    }

    function renderTasks(tasks) {
      // Ð¢Ð²Ð¾Ñ Ð»Ð¾Ð³Ð¸ÐºÐ° Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð·Ð°Ð´Ð°Ñ‡ (kanban)
      console.log('Ð—Ð°Ð´Ð°Ñ‡Ð¸:', tasks);
    }

    // === ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð²ÐºÐ»Ð°Ð´Ð¾Ðº ===
    window.switchTab = function(tabName) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

      document.getElementById(`${tabName}Tab`).classList.add('active');
      event.target.classList.add('active');
    };
  });
</script>